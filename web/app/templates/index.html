<!--
# @name: index.html
# @version: 0.1
# @creation_date: 2022-06-07
# @license: The MIT License <https://opensource.org/licenses/MIT>
# @author: Simon Bowie <simon.bowie.19@gmail.com>
# @purpose: Basic layout for homepage
# @acknowledgements:
# https://www.digitalocean.com/community/tutorials/how-to-make-a-web-application-using-flask-in-python-3
# Bootstrap 5.1.3: https://getbootstrap.com/
-->

{% extends "base.html" %}

{% block content %}
  <div class="container">
    <div class="row">

      <canvas id="carbonGraph" width="600" height="300"></canvas>
      <canvas id="carbonGraphYear" width="600" height="300"></canvas>
      <script>
        function random_rgba() {
          var o = Math.round, r = Math.random, s = 255;
          return 'rgba(' + o(r()*s) + ',' + o(r()*s) + ',' + o(r()*s) + ',' + r().toFixed(1) + ')';
        }

        var x = {{ data['years']|safe }}
        var labels = []
        var car_data = []
        var bus_data = []
        var tram_data = []
        var nationalrail_data = []
        var internationalrail_data = []
        for (var y of x) {
          if (y.hasOwnProperty('months')) {
            for (var z of y['months']) {
              labels.push(z['month'] + " " + y['year'])

              if (z.hasOwnProperty('car')) {
                car_data.push(z['car'])
              }
              else {
                car_data.push('0')
              }
              if (z.hasOwnProperty('bus')) {
                bus_data.push(z['bus'])
              }
              else {
                bus_data.push('0')
              }
              if (z.hasOwnProperty('light rail and tram')) {
                tram_data.push(z['light rail and tram'])
              }
              else {
                tram_data.push('0')
              }
              if (z.hasOwnProperty('national rail')) {
                nationalrail_data.push(z['national rail'])
              }
              else {
                nationalrail_data.push('0')
              }
              if (z.hasOwnProperty('international rail')) {
                internationalrail_data.push(z['international rail'])
              }
              else {
                internationalrail_data.push('0')
              }
            }
          }
        }
        var datasets = []
        datasets.push({label:'car', data:car_data, backgroundColor: random_rgba(),})
        datasets.push({label:'bus', data:bus_data, backgroundColor: random_rgba(),})
        datasets.push({label:'light rail and tram', data:tram_data, backgroundColor: random_rgba(),})
        datasets.push({label:'national rail', data:nationalrail_data, backgroundColor: random_rgba(),})
        datasets.push({label:'international rail', data:internationalrail_data, backgroundColor: random_rgba(),})

        var data = {
          labels: labels,
          datasets: datasets,
        };

        var config = {
          type: 'bar',
          data: data,
          options: {
            plugins: {
              title: {
                display: false,
                text: 'Chart.js Bar Chart - Stacked'
              },
            },
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'month'
                },
                stacked: true,
              },
              y: {
                title: {
                  display: true,
                  text: 'metric tonnes (Mg) of carbon'
                },
                stacked: true
              }
            }
          }
        };

        var carbonGraph = new Chart(
          document.getElementById('carbonGraph'),
          config
        );
      </script>

      <script>
        var annual_labels = []
        var x = {{ data['years']|safe }}
        for (var y of x){
          if (y.hasOwnProperty('months')){
            annual_labels.push(y['year'])
          }
        }

        const car_numbers = car_data.map(str => {
          return Number(str);
        });
        const car_sum = car_numbers.reduce((partialSum, a) => partialSum + a, 0);

        const bus_numbers = bus_data.map(str => {
          return Number(str);
        });
        const bus_sum = bus_numbers.reduce((partialSum, a) => partialSum + a, 0);

        const tram_numbers = tram_data.map(str => {
          return Number(str);
        });
        const tram_sum = tram_numbers.reduce((partialSum, a) => partialSum + a, 0);

        const nationalrail_numbers = nationalrail_data.map(str => {
          return Number(str);
        });
        const nationalrail_sum = nationalrail_numbers.reduce((partialSum, a) => partialSum + a, 0);

        const internationalrail_numbers = internationalrail_data.map(str => {
          return Number(str);
        });
        const internationalrail_sum = internationalrail_numbers.reduce((partialSum, a) => partialSum + a, 0);

        var annual_datasets = []
        annual_datasets.push({label:'car', data:[car_sum], backgroundColor: random_rgba(),})
        annual_datasets.push({label:'bus', data:[bus_sum], backgroundColor: random_rgba(),})
        annual_datasets.push({label:'light rail and tram', data:[tram_sum], backgroundColor: random_rgba(),})
        annual_datasets.push({label:'national rail', data:[nationalrail_sum], backgroundColor: random_rgba(),})
        annual_datasets.push({label:'international rail', data:[internationalrail_sum], backgroundColor: random_rgba(),})

        var data = {
          labels: annual_labels,
          datasets: annual_datasets,
        };

        var config = {
          type: 'bar',
          data: data,
          options: {
            plugins: {
              title: {
                display: false,
                text: 'Chart.js Bar Chart - Stacked'
              },
            },
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'year'
                },
                stacked: true,
              },
              y: {
                title: {
                  display: true,
                  text: 'metric tonnes (Mg) of carbon'
                },
                stacked: true
              }
            }
          }
        };

        var carbonGraphYear = new Chart(
          document.getElementById('carbonGraphYear'),
          config
        );
      </script>

    </div>
  </div>
{% endblock %}
